
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html>
<head>
	<title>Система автоматического оповещения "Сирена"</title>
	<meta http-equiv="content-type" content="text/html; charset=utf-8" />
	<meta http-equiv="Content-Language" content="RU" />
	<meta http-equiv="imagetoolbar" content="no" />
	<meta name="MSSmartTagsPreventParsing" content="true" />
	<meta name="description" content="LGBlue Free Css Template" />
	<meta name="keywords" content="free,css,template,business" />
	<style type="text/css" media="all">@import "images/style.css";</style>
	
</head>

<body>


<div class="content">
	<div id="toph"></div>
	<div id="header">
	
	</div>
	<div id="main">
		<div class="center">
<div align=center><h2>Запуск системы автоматического оповещения</h2></div>
<hr>
 <?php
 //Mysql
 $mysql = mysql_connect("localhost", "root", "vicidialnow") or die(mysql_error());
 mysql_select_db("asterisk") or die(mysql_error());
 
 //Обработка формы
 if ($_SERVER["REQUEST_METHOD"] == "POST") {

//Обзвон абонентов	 
	if(isset($_POST['dial']) &&
   $_POST['dial'] == 'ON') {
	mysql_query("update vicidial_list set status = 'NEW',called_since_last_reset = 'N' where list_id ='". $_POST['list_code']."'") or die(mysql_error());
	}else { 
	$unchoose_count++;
		}
//Выбор кода оповещения		
	if(isset($_POST['alarm_code']) && $unchoose_count < '3') {	     

        mysql_query("update vicidial_campaigns set survey_first_audio_file = '".$_POST['alarm_code']."' where campaign_id = '92355983'") or die(mysql_error());
     
   }
//Рассылка почты
 	if(isset($_POST['mail']) &&
   $_POST['mail'] == 'ON'  && isset($_POST['message'])){
	$subject = '=?utf-8?b?'.base64_encode($_POST['header']).'?=';
        $headers = 'From: callcenter@utg.gazprom.ru' . "\r\n" .
        'Content-Type: text/html; charset=UTF-8' .
        'X-Mailer: PHP/' . phpversion();
    $mail = mysql_query("select email from vicidial_list where list_id ='". $_POST['list_code']."'") or die(mysql_error());    
		while($email = mysql_fetch_array( $mail )) 
		{ 
		mail($email['email'], $subject, $_POST['message'], $headers);
		} 
	}else { 
	$unchoose_count++;
		}
//Рассылка sms
 	if(isset($_POST['sms']) &&
   $_POST['sms'] == 'ON' && isset($_POST['message'])){
	$sql_data = mysql_query("select alt_phone from vicidial_list where list_id ='". $_POST['list_code']."'") or die(mysql_error()) ;
	    
		while (  $phone_number = mysql_fetch_array( $sql_data ) ) 
		{ 
			$phone  = preg_split("/[\9,]+/", $phone_number['alt_phone'] , 2);
                $locale='ru_RU.UTF-8';
                setlocale(LC_ALL,$locale);
                putenv('LC_ALL='.$locale);
                exec('echo "'.$_POST['message'].'" | gammu --sendsms TEXT '.$phone[1].' -unicode');

		} 
	}else { 
	$unchoose_count++;
		}		
//Вывод ошибок
 if($unchoose_count == '3'){
  Print '<div id="warning">Выбери способ оповещения</div>';
  }
	if(empty($_POST['alarm_code']) && isset($_POST['dial'])) { 
	Print '<div id="warning">Выбери код оповещения</div>';
		}	
			if(empty($_POST['list_code'])) { 
		Print '<div id="warning">Выбери список абонентов</div>';
			}	
			if(empty($_POST['message']) && isset($_POST['mail'])) { 
		Print '<div id="warning">Введи текст сообщения</div>';
			} elseif (empty($_POST['message']) && isset($_POST['sms'])) { 
		Print '<div id="warning">Введи текст сообщения</div>';
			}		
//Запись в журнал
if($unchoose_count < '3' && isset($_POST['alarm_code']) && isset($_POST['list_code'])){
	date_default_timezone_set('GMT+3');
	mysql_query('insert into alarm_journal values("'.date("Y-m-d H:i:s").'","'.$_SERVER['REMOTE_ADDR'].'","'.$_POST['dial'].'","'.$_POST['mail'].'","'.$_POST['sms'].'","'.$_POST['alarm_code'].'","'.$_POST['list_code'].'")') or die(mysql_error());
}
}		
 //Статус системы
	
	$status = mysql_fetch_array( mysql_query("select status from vicidial_list where status = 'NEW'") 	or die(mysql_error()) );
	if(empty($status)) {
	Print '<h2>Статус оповещения: Отключено</h2>';
	} else {
		Print '<h2>Статус оповещения: Работа</h2>';
	}
	 
		 ?>
		 <hr>
<form method="post" action="<?php echo htmlspecialchars($_SERVER["PHP_SELF"]);?>">		 
<p>
<h2>Укажи список абонентов:</h2>
<select name="list_code"> 
  <option value="">Выбор...</option>
 <?php 
 //Список абонентов
 $data = mysql_query("select list_id,list_name from vicidial_lists") or die(mysql_error());
  while($list_data = mysql_fetch_array( $data )) 
 { 
  Print "<option value=".$list_data['list_id'].">".$list_data['list_name']."</option>";
}
mysql_close($mysql);
  ?>
</select>
</p>
<hr>
<p>
<h2>Укажи код оповещения:</h2>
<select name="alarm_code">
	<option value="">Выбор...</option>
<?php 
 //Список файлов
 
  foreach(scandir("/var/lib/asterisk/sounds") as $file) 
 { 
	 if (preg_match("/go_/i", $file)) {
	 $name=preg_split("/[\.,]+/", $file);
         Print "<option value=".$name[0].">".$name[0]."</option>";
 }
}
  ?>
</select>
</p>
<hr>
	<h2>Укажи способы оповещения:</h2> 
  <p> 
  <table border=0 cellpadding=4 algin=center > 

<TR>
<TD BGCOLOR="#7FFFF4"><h2>Обзвон абонентов:</h2></TD>
<TD BGCOLOR="#00FF07"> <input type="checkbox" name="dial" value="ON" /></TD>
</TR>
<TR>
<TD BGCOLOR="#7FFFF4"><h2>Рассылка писем:</h2></TD>
<TD BGCOLOR="#00FF07"> <input type="checkbox" name="mail" value="ON" /></TD>
</TR>
<TR>
<TD BGCOLOR="#7FFFF4"><h2>Рассылка смс:</h2></TD>
<TD BGCOLOR="#00FF07"> <input type="checkbox" name="sms" value="ON" /></TD>
</TR>
 </table>
 <hr>
 <h2>Настройки текстового оповещения:</h2>
<input class="spoilerbutton" type="button" value="Показать" onclick="this.value=this.value=='Показать'?'Скрыть':'Показать';">
<div class="spoiler"><div>
	<h2>Введи тему сообщения:</h2>
<input type="text" name="header" value="Проверка системы оповещения."  size="64">
<h2>Введи текст сообщения:</h2>
<textarea name="message" rows="5" cols="74">Проверка системы оповещения.</textarea>
</div></div>
					
 <hr>
 <table border=0 cellpadding=4 algin=center > 
  <TR> 
  <TD BGCOLOR="#FF0000"><h2>---->>>><input type="submit" name="submit" value="Запуск"> <<<<---- </h2></TD>
  </TR>
  </table>
</form>
 
  
  
  
  
<div class="boxads">Прототип системы оповещения.
 Версия 0.5.3<br> <b>Источники информации: </b><br>&#9679; Шаблоны CSS -<a href="http://www.free-css-templates.com">David Herreman </a> 
<br><b>Среда разработки: </b><br>&#9679; Geany.<br> 2015г. ,СЦС. <a href="mailto:samohin-iv@utg.gazprom.ru">Самохин И.В.</a></div>
			</div>
		<div class="leftmenu">
		
			<div class="padding">
	
<img src="images/top_logo.jpg" alt="Газпром трансгаз Саратов"/>
			<br />
			<hr />

			<h2>Ссылки</h2>
			<div class="links">
			<img src="images/arrow.gif" alt="" /> <a href="http://ts.utg.gazprom.ru/telsprav.aspx" target="_blank">Телефонный справочник ООО "Газпром трансгаз Саратов"</a> <br />
			<img src="images/arrow.gif" alt="" /> <a href="http://www.utg.gazprom.ru/newUTG/default.aspx" target="_blank">Официальный сайт ООО "Газпром трансгаз Саратов"</a> <br />
			<br>
			<img src="images/arrow.gif" alt="" /> <a href="http://10.16.101.132" target="_blank">Autodialme</a> <br />
			<img src="images/arrow.gif" alt="" /> <a href="http://10.16.167.14" target="_blank">Freepbx</a> <br />
<img src="images/arrow.gif" alt="" /> <a href="/sirena/list.php" target="_blank">Статус вызовов</a> <br />
<img src="images/arrow.gif" alt="" /> <a href="/vicidial/admin_listloader_fourth_gen.php" target="_blank">Добавление списков</a> <br />
<img src="images/arrow.gif" alt="" /> <a href="/audiostore" target="_blank">Добавление файлов</a> <br />
			</div>
			</div>
		</div>
	</div>
	<br />&nbsp;<br />
	<div id="footer">Copyright &copy; 2015 US | Design: СЦС 
		 
</div>
	
	

</body>
</html>
